{% extends "base.html" %}

{% block title %}Agent - Orchestrate{% endblock %}

{% block content %}
<div class="agent-detail">
    <div class="agent-header">
        <div class="agent-info">
            <h1>
                <span class="badge badge-type">{{ agent.agent_type }}</span>
                Agent
            </h1>
            <p class="agent-id">{{ agent.id }}</p>
        </div>
        <div class="agent-status">
            <span class="badge badge-state-{{ agent.state|lower }} badge-lg">{{ agent.state }}</span>
        </div>
    </div>

    <div class="agent-meta">
        <div class="meta-item">
            <strong>Task:</strong>
            <p>{{ agent.task }}</p>
        </div>
        <div class="meta-row">
            <div class="meta-item">
                <strong>Created:</strong> {{ agent.created_at }}
            </div>
            <div class="meta-item">
                <strong>Updated:</strong> {{ agent.updated_at }}
            </div>
        </div>
        {% if let Some(error) = agent.error_message %}
        <div class="meta-item error-box">
            <strong>Error:</strong>
            <p>{{ error }}</p>
        </div>
        {% endif %}
    </div>

    <div class="agent-controls">
        {% if agent.state == "Running" || agent.state == "WaitingForInput" || agent.state == "WaitingForExternal" %}
        <form action="/agents/{{ agent.id }}/pause" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-warning">Pause</button>
        </form>
        {% else if agent.state == "Paused" %}
        <form action="/agents/{{ agent.id }}/resume" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-success">Resume</button>
        </form>
        {% endif %}
        {% if agent.state != "Completed" && agent.state != "Failed" && agent.state != "Terminated" %}
        <form action="/agents/{{ agent.id }}/terminate" method="POST" style="display:inline;">
            <button type="submit" class="btn btn-danger">Terminate</button>
        </form>
        {% endif %}
        <a href="/agents" class="btn">Back to List</a>
    </div>

    <div class="chat-container">
        <h2>Conversation</h2>
        <div class="messages" id="messages">
            {% for msg in messages %}
            <div class="message message-{{ msg.role }}">
                <div class="message-header">
                    <span class="message-role">{{ msg.role }}</span>
                    <span class="message-time">{{ msg.created_at }}</span>
                </div>
                <div class="message-content">
                    {% if msg.role == "tool" && !msg.tool_results.is_empty() %}
                    <div class="tool-results">
                        {% for result in msg.tool_results %}
                        <div class="tool-result {% if result.is_error %}tool-error{% endif %}">
                            <div class="tool-id">Tool: {{ result.tool_call_id }}</div>
                            <pre>{{ result.content }}</pre>
                        </div>
                        {% endfor %}
                    </div>
                    {% else if msg.role == "assistant" && !msg.tool_calls.is_empty() %}
                    <div class="assistant-content">{{ msg.content }}</div>
                    <div class="tool-calls">
                        {% for call in msg.tool_calls %}
                        <div class="tool-call">
                            <details>
                                <summary>Tool: {{ call.name }}</summary>
                                <pre>{{ call.input }}</pre>
                            </details>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-content">{{ msg.content }}</div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>

        {% if agent.state == "WaitingForInput" || agent.state == "Running" || agent.state == "Paused" %}
        <form action="/agents/{{ agent.id }}/send" method="POST" class="message-form">
            <div class="input-group">
                <textarea name="content" id="messageInput" rows="3" placeholder="Type a message..." required></textarea>
                <button type="submit" class="btn btn-primary">Send</button>
            </div>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-scroll to bottom of messages
const messages = document.getElementById('messages');
if (messages) {
    messages.scrollTop = messages.scrollHeight;
}

// WebSocket for real-time updates
const agentId = "{{ agent.id }}";
initWebSocket(agentId);
</script>
{% endblock %}
