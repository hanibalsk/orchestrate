{% extends "base.html" %}

{% block title %}Agents - Orchestrate{% endblock %}

{% block content %}
<div class="agents-page">
    <div class="page-header">
        <h1>Agents</h1>
        <button class="btn btn-primary" onclick="showCreateModal()">Create Agent</button>
    </div>

    <div class="filters">
        <select id="stateFilter" onchange="filterByState(this.value)">
            <option value="">All States</option>
            <option value="Created">Created</option>
            <option value="Running">Running</option>
            <option value="Paused">Paused</option>
            <option value="WaitingForInput">Waiting for Input</option>
            <option value="Completed">Completed</option>
            <option value="Failed">Failed</option>
            <option value="Terminated">Terminated</option>
        </select>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Type</th>
                <th>State</th>
                <th>Task</th>
                <th>Created</th>
                <th>Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="agentsTable">
            {% for agent in agents %}
            <tr data-state="{{ agent.state }}">
                <td><a href="/agents/{{ agent.id }}">{{ agent.id }}...</a></td>
                <td><span class="badge badge-type">{{ agent.agent_type }}</span></td>
                <td><span class="badge badge-state-{{ agent.state|lower }}">{{ agent.state }}</span></td>
                <td class="task-cell" title="{{ agent.task }}">{{ agent.task }}</td>
                <td>{{ agent.created_at }}</td>
                <td>{{ agent.updated_at }}</td>
                <td class="actions">
                    <a href="/agents/{{ agent.id }}" class="btn btn-sm">View</a>
                    {% if agent.state == "Running" %}
                    <form action="/agents/{{ agent.id }}/pause" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-warning">Pause</button>
                    </form>
                    {% else if agent.state == "Paused" %}
                    <form action="/agents/{{ agent.id }}/resume" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-success">Resume</button>
                    </form>
                    {% endif %}
                    {% if agent.state != "Completed" && agent.state != "Failed" && agent.state != "Terminated" %}
                    <form action="/agents/{{ agent.id }}/terminate" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-danger">Terminate</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Create Agent Modal -->
<div id="createModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Create New Agent</h3>
            <button class="modal-close" onclick="hideCreateModal()">&times;</button>
        </div>
        <form action="/agents/create" method="POST">
            <div class="form-group">
                <label for="agent_type">Agent Type</label>
                <select name="agent_type" id="agent_type" required>
                    <option value="StoryDeveloper">Story Developer</option>
                    <option value="CodeReviewer">Code Reviewer</option>
                    <option value="IssueFixer">Issue Fixer</option>
                    <option value="Explorer">Explorer</option>
                    <option value="PrShepherd">PR Shepherd</option>
                </select>
            </div>
            <div class="form-group">
                <label for="task">Task Description</label>
                <textarea name="task" id="task" rows="4" required placeholder="Describe the task..."></textarea>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="hideCreateModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Agent</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
}
function hideCreateModal() {
    document.getElementById('createModal').style.display = 'none';
}
function filterByState(state) {
    const rows = document.querySelectorAll('#agentsTable tr');
    rows.forEach(row => {
        if (!state || row.dataset.state === state) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
